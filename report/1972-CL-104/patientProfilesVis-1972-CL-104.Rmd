---
title: "1972-CL-104 study"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{patientProfilesVis package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
	heightLineIn  <- 0.2
	
```

This package `patientProfilesVis` enables to create report containing subject
profiles.

```{r loadPackages}

	library(patientProfilesVis)
	library(pander)

```

# Load the data

```{r loadData}	
	
	dataFiles <- list.files(pattern = "sas7bdat", path = "../../data/1972-CL-104/", full.names = TRUE)
	dataRes <- loadDataADaMSDTM(dataFiles)
	data <- dataRes
	labelVars <- attr(dataRes, "labelVars")

```

# Create the report

The following code create the different modules, and the resulting report.
Please note that the `createSubjectProfileReport` should be called in the R
session directly (not within the call to `knitr`).

```{r createReport, eval = FALSE}

	# remove the 45 patients with screen failure
	dataSL <- subset(data$ADSL, ARM != "Screen Failure")
	treatments <- unique(dataSL$ARM)
	treatmentsOrdered <- c(sapply(c("Placebo", "GLPG1972"), function(treat)
		sapply(c(100, 200, 300), function(dose)
			grep(paste0(dose, "mg ", treat), treatments, value = TRUE)
		)
	))
	dataSL$ARM <- factor(dataSL$ARM, levels = treatmentsOrdered)
	subjectIDs <- dataSL$USUBJID

	## info patient
	infoPatientPlots <- subjectProfileTextPlot(
		data = dataSL,
		paramValueVar = c("ANALGR1", "SEX", "ARM"),
		title = "Patient information",
		labelVars = labelVars
	)

	## adverse event
	# AEPTCD: preferred term code
	dataPlot <- subset(data$ADAE, AETERM != "" & USUBJID %in% subjectIDs)
	# specify order of value in 'AESEV'
	dataPlot[, "AESEV"] <- factor(dataPlot[, "AESEV"], levels = c("MILD", "MODERATE"))
	aePlots <- subjectProfileIntervalPlot(
		data = dataPlot,
		paramVar = "AETERM",
		timeStartVar = "AESTDY",
		timeEndVar = "AEENDY",
		colorVar = "AESEV",
		labelVars = labelVars,
		title = "Adverse events"
	)

    ### laboratory data

#	dataLB <- data$ADLB
#	params <- unique(dataLB[, c("PARAMCD", "PARAM")])
#	subset(params, grepl("leuk", PARAM, ignore.case = TRUE))

	# prepare data for plots:
	# leuko = WBC, CRP
	# Note: ADY is missing (NA) when AVISIT is Worst-case scenario, but remote the records for safety
	
	lbParams <- c("MONO", "LYM", "BASO", "WBC", "PLAT", "ALT", "AST", "ALP", "GGT", "EOS", "NEUT", "CRP")
	dataLB <- subset(data$ADLB, 
		PARAMCD %in% lbParams &
#		AVISIT != "Worst" &
		USUBJID %in% subjectIDs
	)
	# sort the categories (empty values '' becomes NA)
	dataLB$ANRIND <- factor(dataLB$ANRIND, levels = c("LOW", "NORMAL", "HIGH"))
	dataLB$PARAMCD <- factor(dataLB$PARAMCD)

	# create plot
	lbPlots <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "PARAMCD", #paramGroupVar = "LBTESTCD",
		colorVar = "ANRIND", shapeVar = "ANRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24),
		timeVar = "ADY",
		labelVars = labelVars,
		title = "Laboratory test measurements: reference range indicator"
	)

	# create plot
	lbPlotsSpagh <- subjectProfileLinePlot(
		data = dataLB,
		paramValueVar = "AVAL",
		paramNameVar = "PARAMCD",
		timeVar = "ADY",
		labelVars = labelVars,
		title = "Laboratory test measurements: line plots"
	)

    ## vital signs temperature

	dataVSTemp <- subset(data$ADVS, 
		PARAMCD == "TEMP" & USUBJID %in% subjectIDs)
	# create plot
	# A1CLSIG: Clinically Significant 1 

	tempVsPlots <- subjectProfileLinePlot(
		data = dataVSTemp,
		paramValueVar = "AVAL",
		paramNameVar = "PARAMCD",
		timeVar = "ADY",
		labelVars = labelVars,
		title = "Vital signs"
	)

	# create report
	createSubjectProfileReport(
		listPlots = list(infoPatientPlots, aePlots, lbPlots, lbPlotsSpagh, tempVsPlots),
		outputFile = "subjectProfile_1972-CL-104_MAD.pdf",
		maxNLines = 100,
		# sort subject by arm
		subjectSortData = dataSL,
		subjectSortVar = "ARM"
	)

```

# Appendix

## Session information


```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
