---
title: "Vignette of the `patientProfilesVis` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{patientProfilesVis package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
	heightLineIn  <- 0.2
	
```

This package `patientProfilesVis` enables to create report containing subject
profiles.

```{r loadPackages}

	library(patientProfilesVis)
	library(pander)

```

## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame` containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored in the `$labelVars` slot

A few `sdtm` datasets from the _Pelican_ study are included in the package for
the demonstration, via the dataset `SDTMDataPelican` and corresponding variable
labels `labelVarsSDTMPelican`.

```{r loadData}	
	
	# example dataset(s) formatted as a list of data.frame
	data(SDTMDataPelican)
	pander(lapply(SDTMDataPelican, head, 1))
	
	# and corresponding labels
	data(labelVarsSDTMPelican)
	pander(head(labelVarsSDTMPelican))

```

# Creation of the plot submodules

Three plot types/modules are currently available in the package:

* **'text'** module: patient specific information formatted as text, available
  via the `subjectProfileTextPlot` function
* **'interval'** module: representation of time interval of a certain event,
  available via the `subjectProfileIntervalPlot` function
* **'event'** module: representation of single event, available via the
  `subjectProfileEventPlot`
* **'line'** module: representation of evolution of a value across time via the 
`subjectProfileLinePlot`
  
Each of this function returns a list of plots (`ggplot` object), one for each
subject. 
  
## Text module

The 'text' module enables to specify meta-information for each subject.
There are two ways to specify such information, either by specifying a set of
variables/columns of the data (`paramValueVar` only), or by a variable/column
containing the parameter name (`paramNameVar`) and a variable/column containing
the parameter value (`paramValueVar`).

### Wide format

```{r exampleTestModule-wideFormat}

	# annotate subject demographics meta-data
	# by specifying a set of variables to include
	dmPlots <- subjectProfileTextPlot(
		data = SDTMDataPelican$DM,
		paramValueVar = c("SEX|AGE", "RACE|COUNTRY", "ARM"),
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleTestModule-wideFormat-include, echo = FALSE, fig.height = getNLinesYGgplot(dmPlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Demographic information with the 'subjectProfileTextPlot' function for patient:", names(dmPlots)[1])}

	print(dmPlots[[1]])

```

### Long format

#### No grouping

```{r exampleTestModule-longFormat-noGrouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlots <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		title = "Medical History: status",
		labelVars = labelVarsSDTMPelican
	)
		
```

```{r exampleTestModule-longFormat-noGrouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlots)[1])}

	print(mhPlots[[1]])

```

### Multiple variables

```{r exampleTestModule-longFormat-multipleVariables}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	paramValueVarFct <- function(data)
		with(data, paste0(MHENRTPT, " (start = ", MHSTDTC, 
			ifelse(MHENDTC != "", paste0(", end = ", MHENDTC, ")"), ")")
			)
		)
	mhPlotsMultipleVars <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = paramValueVarFct,
		title = "Medical History: status with dates",
		labelVars = labelVarsSDTMPelican
	)
		
```

```{r exampleTestModule-longFormat-multipleVariables-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsMultipleVars[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsMultipleVars)[1])}

	print(mhPlotsMultipleVars[[1]])

```

### With grouping

```{r exampleTestModule-longFormat-grouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlotsGroup <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		paramGroupVar = "MHCAT",
		title = "Medical History: grouped by category",
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleTestModule-longFormat-grouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsGroup[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsGroup)[1])}

	print(mhPlotsGroup[[1]])

```

## Interval/Range module

The 'interval' module enables to represent a time interval for
some parameters/events of interest.

### Adverse events

It is used here to represent the start/end date of the adverse events.

Please note that if a end date is not available for a certain record, the
maximum of the time limits (`timeLim` parameter) is used.
By default, these time limits are extracted from the minimum/maximum
time availabl ein the `timeStartVar`/`timeEndVar` (so specific of the
represented dataset).

```{r exampleIntervalModule-ae}

	# AEPTCD: preferred term code
	dataPlot <- SDTMDataPelican$AE
	# specify order of value in 'AESEV'
	dataPlot[, "AESEV"] <- factor(dataPlot[, "AESEV"], levels = c("MILD", "MODERATE"))
	aePlots <- subjectProfileIntervalPlot(
		data = dataPlot,
		paramVar = "AETERM",
		timeStartVar = "AESTDY",
		timeEndVar = "AEENDY",
		colorVar = "AESEV",
		labelVars = labelVarsSDTMPelican,
		title = "Adverse events"
	)
	
```

```{r exampleIntervalModule-ae-include, echo = FALSE, fig.height = getNLinesYGgplot(aePlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Adverse events with the 'subjectProfileIntervalPlot' function for patient:", names(aePlots)[1])}

	print(aePlots[[1]])

```

### Exposure

The exposure of the patients to certain treatment(s) is also represented in
this time interval visualization

```{r exampleIntervalModule-ex}

	# AEPTCD: preferred term codes
	exPlots <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$EX,
		paramVar = c("EXTRT", "EXDOSE", "EXDOSU"),
		timeStartVar = "EXSTDY",
		timeEndVar = "EXENDY",
		colorVar = "EXDOSFRM",
		labelVars = labelVarsSDTMPelican,
		title = "Treatment exposure"
	)

```

```{r exampleIntervalModule-exinclude, echo = FALSE, fig.height = getNLinesYGgplot(exPlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Exposure interval with the 'subjectProfileIntervalPlot' function for patient:", names(aePlots)[1])}

	print(exPlots[[1]])

```

### Concomitant medications

```{r exampleIntervalModule-cm}

	# AEPTCD: preferred term codes
	cmPlots <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$CM,
		paramVar = c("CMINDC", "CMDECOD", "CMDOSTXT", "CMDOSU", "CMROUTE", "CMDOSFRQ"),
		timeStartVar = "CMSTDY",
		timeEndVar = "CMENDY",
		paramGroupVar = "CMINDC",
		colorVar = "CMINDC",
		labelVars = labelVarsSDTMPelican,
		title = "Concomitant medications"
	)

```

```{r exampleIntervalModule-cm-include, echo = FALSE, fig.height = getNLinesYGgplot(cmPlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Concomitant medications with the 'subjectProfileIntervalPlot' function for patient:", names(cmPlots)[1])}

	print(cmPlots[[1]])

```

## Event module

The 'event' module enables to represent event data.

This is used to represent the presence/absence of a certain
laboratory measurement (and corresponding time).

```{r exampleEventModule}
	
	## laboratory data
	
	# prepare data for plots:
	dataLB <- SDTMDataPelican$LB
	# sort the categories (empty values '' becomes NA)
	dataLB$LBNRIND <- factor(dataLB$LBNRIND, levels = c("LOW", "NORMAL", "HIGH"))
	
	# create plot
	lbPlots <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		paramGroupVar = "LBSCAT",
		timeVar = "LBDY",
		labelVars = labelVarsSDTMPelican,
		title = "Laboratory test measurements"
	)

```

```{r exampleEventModule-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileEventPlot' function for patient:", names(lbPlots)[1])}

	print(lbPlots[[1]])

```

The reference range indicator is used to color the presence/absence of the
laboratory data via the `colorVar` parameter.
This parameter is also used for the symbol via the `shapeVar` variable.
Symbols specific of this categorization are used via the `shapePalette`
parameter: bottom/top arrow for low/high measurements, and dot for measurements
in normal range.

```{r exampleEventModuleWithColor}

	# create plot
	lbPlotsColor <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		paramGroupVar = "LBSCAT",
		timeVar = "LBDY",
		colorVar = "LBNRIND",
		labelVars = labelVarsSDTMPelican,
		shapeVar = "LBNRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24),
		title = "Laboratory test measurements: reference range indicator"
	)
	
```

```{r exampleEventModuleWithColor-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlotsColor[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileEventPlot' function for patient:", names(lbPlotsColor)[1])}

	print(lbPlotsColor[[1]])

```

## Line module

The 'line' module enables to represent value of a variable across time.

This is used to represent the evolution of the lab parameters.

The reference range (`paramValueRangeVar` variable) of each variable is
highlighted in the plot.

```{r exampleLineModule}

	# create plot
	lbLinePlots <- subjectProfileLinePlot(
		data = dataLB,
		paramNameVar = "LBTEST", #LBTESTCD
		paramValueVar = "LBSTRESN",
		paramGroupVar = "LBSCAT",
		paramValueRangeVar = c("LBSTNRLO", "LBSTNRHI"),
		timeVar = "LBDY",
		title = "Laboratory test measurements: actual value",
		label = "defaultSDTMLBLine",
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleLineModule-include, echo = FALSE, fig.height = getNLinesYGgplot(lbLinePlots[[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileLinePlot' function for patient:", names(lbLinePlots)[1])}

	print(lbLinePlots[[1]])

```

# Creation of subject report

The function `createSubjectProfileReport` has mainly two purposes:

* combining the plots of each patient across modules (via the
  `subjectProfileCombine` function)
* creating a _pdf_ report containing the resulting plots (one page per subject)

## Reference lines for Statistical Analysis Plan

```{r createReportWithAllModules-referenceLinesFromSAP, eval = FALSE}

	# reference lines input parameter
	library(glpgStyle)
	refLinesParam <- list(
		list(
			label = 'Start screening',
			time = -28,
			color = glpgPaletteCharts()["purple"]
		), 
		list(
			label = 'End screening',
			time = -1,
			color = glpgPaletteCharts()["purple"]
		), 
		list(
			label = 'Start treatment',
			time = 1,
			color = glpgPaletteCharts()["darkblue"]
		), 
		list(
			label = 'End treatment',
			time = 29,
			color = glpgPaletteCharts()["darkblue"]
		),
		list(
			label = 'Follow-up',
			time = 49,
			color = glpgPaletteCharts()["pink"]
		)
	)

	# create report
	createSubjectProfileReport(
		listPlots = list(dmPlots, mhPlots, exPlots, aePlots, lbLinePlots, lbPlotsColor),
		refLines = refLinesParam,
		outputFile = "subjectProfile_SDTM_referenceLinesFromSAP.pdf"
	)

```

## Reference lines from subject visits

In the following example: the reference lines are extracted from the subject
visits: `SV` dataset. Bookmarks are used to reference the sex and arm for each
subject.

```{r createReportWithAllModules-referenceLinesFromSV, eval = FALSE}

	# create report
	createSubjectProfileReport(
		# general
		listPlots = list(dmPlots, mhPlots, exPlots, aePlots, lbPlotsColor),
		outputFile = "subjectProfile_SDTM_referenceLinesFromSV.pdf",
		# reference line(s)
		refLinesData = SDTMDataPelican$SV,
		refLinesTimeVar = "SVSTDY",
		refLinesLabelVar = "VISIT",
		# bookmark(s)
		bookmarkData = SDTMDataPelican$DM,
		bookmarkVar = c("SEX", "ARM"),
		labelVars = attr(SDTMDataPelican, "labelVars"),
		exportFigures = TRUE
	)

```

## Example with the 'ADaM' dataset/format

ADaM dataset can also be used in the same framework.

```{r createReportFromADAMDataset, eval = FALSE}

	# load example ADaM dataset
	data(ADaMDataPelican)
	# ... and corresponding labels
	data(labelVarsADaMPelican)

	# subject information
	slPlotsADaM <- subjectProfileTextPlot(
		ADaMDataPelican$ADSL,
		paramValueVar = c("SEX|AGE", "RACE|COUNTRY", "ARM"),
		labelVars = labelVarsADaMPelican
	)
	# medical history
	mhPlotsADaM <- subjectProfileTextPlot(
		ADaMDataPelican$ADMH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		title = "Medical History: status",
		labelVars = labelVarsADaMPelican
	)
	# exposure
	exPlotsADaM <- subjectProfileIntervalPlot(
		data = ADaMDataPelican$ADEX,
		paramVar = c("EXTRT", "EXDOSE", "EXDOSU"),
		timeStartVar = "EXSTDY",
		timeEndVar = "EXENDY",
		colorVar = "EXDOSFRM",
		labelVars = labelVarsADaMPelican,
		title = "Treatment exposure"
	)
	# adverse events
	aePlotsADaM <- subjectProfileIntervalPlot(
		data = ADaMDataPelican$ADAE,
		paramVar = "AETERM",
		timeStartVar = "ASTDY",
		timeEndVar = "AENDY",
		colorVar = "AESEV",
		labelVars = labelVarsADaMPelican,
		title = "Adverse events"
	)
	# laboratory	
	lbPlotsADaM <- subjectProfileEventPlot(
		data = ADaMDataPelican$ADLB,
		paramVar = "PARAM",
		paramGroupVar = c("PARCAT1", "PARCAT2"),
		timeVar = "ADY",
		colorVar = "ANRIND",
		labelVars = labelVarsADaMPelican,
		shapeVar = "ANRIND",
		title = "Laboratory test measurements",
		shapePalette = c('L' = 25, 'N' = 19, 'H' = 24, 'NA' = 3)
	)

	# create report
	createSubjectProfileReport(
		listPlots = list(slPlotsADaM, mhPlotsADaM, 
			exPlotsADaM, aePlotsADaM, lbPlotsADaM
		),
		refLines = refLinesParam,
		outputFile = "subjectProfile_ADAM.pdf"
	)

```

# Appendix

## Session information


```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
