---
title: "Vignette of the `patientProfilesVis` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{patientProfilesVis package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

This package `patientProfilesVis` enables to create report containing subject
profiles.

```{r loadPackages}

	library(patientProfilesVis)
	library(pander)

```

## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame` containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored in the `$labelVars` slot

A few `sdtm` datasets from the _Pelican_ study are included in the package for
the demonstration, via the dataset `sdtmDataPelican` and corresponding variable
labels `labelVarsPelican`.

```{r loadData}	
	
	# example dataset(s) formatted as a list of data.frame
	data(sdtmDataPelican)
	pander(lapply(sdtmDataPelican, head, 1))
	
	# and corresponding labels
	data(labelVarsPelican)
	pander(head(labelVarsPelican))

```

# Creation of the plot submodules

Three plot types/modules are currently available in the package:

* **'text'** module: patient specific information formatted as text, available
  via the `subjectProfileTextPlot` function
* **'interval'** module: representation of time interval of a certain event,
  available via the `subjectProfileIntervalPlot` function
* **'event'** module: representation of single event, available via the
  `subjectProfileEventPlot`
  
Each of this function returns a list of plots (`ggplot` object), one for each
subject. 
  
## Text module

The 'text' module enables to specify meta-information for each subject.
There are two ways to specify such information, either by specifying a set of
variables/columns of the data (`paramValueVar` only), or by a variable/column
containing the parameter name (`paramNameVar`) and a variable/column containing
the parameter value (`paramValueVar`).

### Wide format

```{r exampleTestModule-wideFormat}

	# annotate subject demographics meta-data
	# by specifying a set of variables to include
	dmPlots <- subjectProfileTextPlot(
		data = sdtmDataPelican$DM,
		paramValueVar = c("SEX|AGE", "RACE|COUNTRY", "ARM"),
		labelVars = labelVarsPelican
	)
	
```

```{r exampleTestModule-wideFormat-include, echo = FALSE, fig.height = getNLinesYGgplot(dmPlots[[1]])*0.14, fig.width = 14, fig.cap = paste("Demographic information with the 'subjectProfileTextPlot' function for patient:", names(dmPlots)[1])}

	print(dmPlots[[1]])

```

### Long format

#### No grouping

```{r exampleTestModule-longFormat-noGrouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlots <- subjectProfileTextPlot(
		data = sdtmDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		title = "Medical History: status",
		labelVars = labelVarsPelican
	)
		
```

```{r exampleTestModule-longFormat-noGrouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlots[[1]])*0.14, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlots)[1])}

	print(mhPlots[[1]])

```

### Multiple variables

```{r exampleTestModule-longFormat-multipleVariables}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	paramValueVarFct <- function(data)
		with(data, paste0(MHENRTPT, " (start = ", MHSTDTC, 
			ifelse(MHENDTC != "", paste0(", end = ", MHENDTC, ")"), ")")
			),
		)
	mhPlotsMultipleVars <- subjectProfileTextPlot(
		data = sdtmDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = paramValueVarFct,
		title = "Medical History: status with dates",
		labelVars = labelVarsPelican
	)
		
```

```{r exampleTestModule-longFormat-multipleVariables-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsMultipleVars[[1]])*0.14, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsMultipleVars)[1])}

	print(mhPlotsMultipleVars[[1]])

```

### With grouping

```{r exampleTestModule-longFormat-grouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlotsGroup <- subjectProfileTextPlot(
		data = sdtmDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		paramGroupVar = "MHCAT",
		title = "Medical History: grouped by category",
		labelVars = labelVarsPelican
	)
	
```

```{r exampleTestModule-longFormat-grouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsGroup[[1]])*0.14, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsGroup)[1])}

	print(mhPlotsGroup[[1]])

```

## Interval/Range module

The 'interval' module enables to represent a time interval for
some parameters/events of interest.

### Adverse events

It is used here to represent the start/end date of the adverse events.

```{r exampleIntervalModule-ae}

	# AEPTCD: preferred term code
	dataPlot <- sdtmDataPelican$AE
	# specify order of value in 'AESEV'
	dataPlot[, "AESEV"] <- factor(dataPlot[, "AESEV"], levels = c("MILD", "MODERATE"))
	aePlots <- subjectProfileIntervalPlot(
		data = dataPlot,
		paramVar = "AETERM",
		startVar = "AESTDY",
		endVar = "AEENDY",
		colorVar = "AESEV",
		labelVars = labelVarsPelican
	)
	
```

```{r exampleIntervalModule-ae-include, echo = FALSE, fig.height = getNLinesYGgplot(aePlots[[1]])*0.14, fig.width = 14, fig.cap = paste("Adverse events with the 'subjectProfileIntervalPlot' function for patient:", names(aePlots)[1])}

	print(aePlots[[1]])

```

## Event module

The 'event' module enables to represent event data.

This is used to represent the presence/absence of a certain
laboratory measurement (and corresponding time).

```{r exampleEventModule}
	
	## laboratory data
	
	# prepare data for plots:
	dataLB <- sdtmDataPelican$LB
	# sort the categories (empty values '' becomes NA)
	dataLB$LBNRIND <- factor(dataLB$LBNRIND, levels = c("LOW", "NORMAL", "HIGH"))
	
	# create plot
	lbPlots <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		paramGroupVar = "LBSCAT",
		subjectVar = "USUBJID",
		timeVar = "LBDY",
		labelVars = labelVarsPelican
	)

```

```{r exampleEventModule-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlots[[1]])*0.14, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileEventPlot' function for patient:", names(lbPlots)[1])}

	print(lbPlots[[1]])

```

The reference range indicator is used to color the presence/absence of the
laboratory data via the `colorVar` parameter.
This parameter is also used for the symbol via the `shapeVar` variable.
Symbols specific of this categorization are used via the `shapePalette`
parameter: bottom/top arrow for low/high measurements, and dot for measurements
in normal range.

```{r exampleEventModuleWithColor}

	# create plot
	lbPlotsColor <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		subjectVar = "USUBJID",
		timeVar = "LBDY",
		colorVar = "LBNRIND",
		labelVars = labelVarsPelican,
		shapeVar = "LBNRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24)
	)
	
```

```{r exampleEventModuleWithColor-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlotsColor[[1]])*0.14, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileEventPlot' function for patient:", names(lbPlotsColor)[1])}

	print(lbPlotsColor[[1]])

```

# Creation of subject report

The function `createSubjectProfileReport` has mainly two purposes:

* combining the plots of each patient across modules (via the
  `subjectProfileCombine` function)
* creating a _pdf_ report containing the resulting plots (one page per subject)

```{r createReportWithAllModules, eval = FALSE}

	createSubjectProfileReport(
		listPlots = list(dmPlots, mhPlots, aePlots, lbPlotsColor)
	)

```

# Appendix

## Session information


```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
