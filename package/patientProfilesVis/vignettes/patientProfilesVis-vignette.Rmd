---
title: "Vignette of the `patientProfilesVis` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{patientProfilesVis package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
	heightLineIn  <- 0.2
	
```

This package `patientProfilesVis` enables to create report containing subject
profiles.

```{r loadPackages}

	library(patientProfilesVis)
	library(pander)

```

## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` can be used to load your custom `SAS` dataset(s) of
interest.
This function returns two objects:

* a list of `data.frame` containing the data for each _SAS_ dataset(s), stored
  in the `$data` slot
* a vector containing the labels for each column of the data (used e.g. for
  default titles of the figures), stored in the `$labelVars` slot

A few `sdtm` datasets from the _Pelican_ study are included in the package for
the demonstration, via the dataset `SDTMDataPelican` and corresponding variable
labels `labelVarsSDTMPelican`.

```{r loadData}	
	
	# example dataset(s) formatted as a list of data.frame
	data(SDTMDataPelican)
	pander(lapply(SDTMDataPelican, head, 1))
	
	# and corresponding labels
	data(labelVarsSDTMPelican)
	pander(head(labelVarsSDTMPelican))

```

# Creation of the plot submodules

Three plot types/modules are currently available in the package:

* **'text'** module: patient specific information formatted as text, available
  via the `subjectProfileTextPlot` function
* **'interval'** module: representation of time interval of a certain event,
  available via the `subjectProfileIntervalPlot` function
* **'event'** module: representation of single event, available via the
  `subjectProfileEventPlot`
* **'line'** module: representation of evolution of a value across time via the 
`subjectProfileLinePlot`
  
Each of this function returns a nested list of plots (`ggplot` object).
Each element of the list contains the plots for a specific subject.
The subject profile plot for a specific module is possibly into
multiple plots to fit in the final report (`formatReport` parameter).
  
## Text module

The 'text' module enables to specify meta-information for each subject.
There are two ways to specify such information, either by specifying a set of
variables/columns of the data (`paramValueVar` only), or by a variable/column
containing the parameter name (`paramNameVar`) and variable(s)/column(s)
containing the parameter value (`paramValueVar`).

### Wide format

```{r exampleTextModule-wideFormat}

	# annotate subject demographics meta-data
	# by specifying a set of variables to include
	dmPlots <- subjectProfileTextPlot(
		data = SDTMDataPelican$DM,
		paramValueVar = c("SEX|AGE", "RACE|COUNTRY", "ARM"),
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleTextModule-wideFormat-include, echo = FALSE, fig.height = getNLinesYGgplot(dmPlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Demographic information with the 'subjectProfileTextPlot' function for patient:", names(dmPlots)[1])}

	print(dmPlots[[1]][[1]])

```

### Long format

#### General

It is possible to specify multiple variable to represent in the plot
for a certain variable name.

```{r exampleTextModule-longFormat-noGrouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlots <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHTERM",
		paramValueVar = c("MHCAT", "MHSTDTC", "MHENDTC"),
		title = "Medical History: status",
		labelVars = labelVarsSDTMPelican
	)
		
```

```{r exampleTextModule-longFormat-noGrouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlots)[1])}

	print(mhPlots[[1]][[1]])

```

#### Customization for multiple variables

In case multiple variable are used as `paramValueVar` and
they should be concatenated with a specific format, a function
 can be specified via the parameter: `paramValueVar`.

```{r exampleTextModule-longFormat-multipleVariables}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	paramValueVarFct <- function(data)
		with(data, paste0(MHENRTPT, " (start = ", MHSTDTC, 
			ifelse(MHENDTC != "", paste0(", end = ", MHENDTC, ")"), ")")
			)
		)
	mhPlotsMultipleVars <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = paramValueVarFct,
		title = "Medical History: status with dates",
		labelVars = labelVarsSDTMPelican
	)
		
```

```{r exampleTextModule-longFormat-multipleVariables-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsMultipleVars[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsMultipleVars)[1])}

	print(mhPlotsMultipleVars[[1]][[1]])

```

#### With grouping

```{r exampleTextModule-longFormat-grouping}	

	# annotate subject medical history
	# by specifying a combination of parameter value/name
	mhPlotsGroup <- subjectProfileTextPlot(
		data = SDTMDataPelican$MH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		paramGroupVar = "MHCAT",
		title = "Medical History: grouped by category",
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleTextModule-longFormat-grouping-include, echo = FALSE, fig.height = getNLinesYGgplot(mhPlotsGroup[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Medical history with the 'subjectProfileTextPlot' function for patient:", names(mhPlotsGroup)[1])}

	print(mhPlotsGroup[[1]][[1]])

```

## Interval/Range module

The 'interval' module enables to represent a time interval for
some parameters/events of interest.

### Adverse events

It is used here to represent the start/end date of the adverse events.

Please **have a look at the section 'Details' of the documentation of the
`subjectProfileIntervalPlot` function for further information on records with
missing start/end date are represented**.

```{r exampleIntervalModule-ae}

	# AEPTCD: preferred term code
	dataPlot <- SDTMDataPelican$AE
	# specify order of value in 'AESEV'
	dataPlot[, "AESEV"] <- factor(dataPlot[, "AESEV"], levels = c("MILD", "MODERATE"))
	aePlots <- subjectProfileIntervalPlot(
		data = dataPlot,
		paramVar = "AETERM",
		timeStartVar = "AESTDY",
		timeEndVar = "AEENDY",
		colorVar = "AESEV",
		labelVars = labelVarsSDTMPelican,
		title = "Adverse events"
	)
	
```

```{r exampleIntervalModule-ae-include, echo = FALSE, fig.height = getNLinesYGgplot(aePlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Adverse events with the 'subjectProfileIntervalPlot' function for patient:", names(aePlots)[1])}

	print(aePlots[[1]][[1]])

```

To set the values represented for records with missing start/end dates,
the time limits can be specified via the `timeLim` parameter or a dataset,
or extracted from a specified dataset containing the start/end date for each
patient via the `timeLimData` and `timeLimVar` parameters.
The second option is used below to extract the time limits based on all visits
for a specific subject from the subject-level SDTM dataset.

```{r exampleIntervalModule-ae-timeLimData}

	aePlotsTimLimFromSV <- subjectProfileIntervalPlot(
		data = dataPlot,
		paramVar = "AETERM",
		timeStartVar = "AESTDY",
		timeEndVar = "AEENDY",
		colorVar = "AESEV",
		labelVars = labelVarsSDTMPelican,
		title = "Adverse events",
		timeLimData = SDTMDataPelican$SV,
		timeLimStartVar = "SVSTDY", 
		timeLimEndVar = "SVENDY"
	)
	
```

```{r exampleIntervalModule-ae-timeLimData-include, echo = FALSE, fig.height = getNLinesYGgplot(aePlotsTimLimFromSV[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste0("Adverse events with the 'subjectProfileIntervalPlot' function for patient:", names(aePlotsTimLimFromSV)[1], ". Missing start/end date are extracted from the subject-level datasets.")}

	print(aePlotsTimLimFromSV[[1]][[1]])

```

### Exposure

The exposure of the patients to certain treatment(s) is also represented in
this time interval visualization

```{r exampleIntervalModule-ex}

	# AEPTCD: preferred term codes
	exPlots <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$EX,
		paramVar = c("EXTRT", "EXDOSE", "EXDOSU"),
		timeStartVar = "EXSTDY",
		timeEndVar = "EXENDY",
		colorVar = "EXDOSFRM",
		labelVars = labelVarsSDTMPelican,
		title = "Treatment exposure"
	)

```

```{r exampleIntervalModule-exinclude, echo = FALSE, fig.height = getNLinesYGgplot(exPlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Exposure interval with the 'subjectProfileIntervalPlot' function for patient:", names(aePlots)[1])}

	print(exPlots[[1]][[1]])

```

### Concomitant medications

```{r exampleIntervalModule-cm}

	# AEPTCD: preferred term codes
	cmPlots <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$CM,
		paramVar = c("CMINDC", "CMDECOD", "CMDOSTXT", "CMDOSU", "CMROUTE", "CMDOSFRQ"),
		timeStartVar = "CMSTDY",
		timeEndVar = "CMENDY",
		paramGroupVar = "CMINDC",
		colorVar = "CMINDC",
		labelVars = labelVarsSDTMPelican,
		title = "Concomitant medications"
	)

```

```{r exampleIntervalModule-cm-include, echo = FALSE, fig.height = getNLinesYGgplot(cmPlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Concomitant medications with the 'subjectProfileIntervalPlot' function for patient:", names(cmPlots)[1])}

	print(cmPlots[[1]][[1]])

```

By default, in case of missing values the minimum/maximum time range for the
specific subject is used, and across subjects if all missing. This results
in big time range for this plot.

The time limits of the concomitant medications is quite large compared to the
study time range.
As the modules will be combined with the same time limits, it might be
advisable to restrict the time limits for this module via the `timeLimData`,
`timeLimStartVar` and `timeLimEndVar` parameter.
In this example the time limits are restricted to the minimum/maximum
time range of the subject visits.

```{r exampleIntervalModule-cm-restrictedTimeLimits}

	cmPlotsTimeSV <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$CM,
		paramVar = c("CMINDC", "CMDECOD", "CMDOSTXT", "CMDOSU", "CMROUTE", "CMDOSFRQ"),
		timeStartVar = "CMSTDY",
		timeEndVar = "CMENDY",
		paramGroupVar = "CMINDC",
		colorVar = "CMINDC",
		labelVars = labelVarsSDTMPelican,
		title = "Concomitant medications",
		timeLimData = SDTMDataPelican$SV,
		timeLimStartVar = "SVSTDY",
		timeLimEndVar = "SVENDY"
	)

```

```{r exampleIntervalModule-cm-restrictedTimeLimits-include, echo = FALSE, fig.height = getNLinesYGgplot(cmPlotsTimeSV[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Concomitant medications with the 'subjectProfileIntervalPlot' function for patient:", names(cmPlots)[1], "with time limits restricted to subject visits")}

	print(cmPlotsTimeSV[[1]][[1]])

```

Please note that the same behaviour can be obtained by specifying directly the
time limits via the `timeLim` parameter:

```{r exampleIntervalModule-cm-restrictedTimeLimits2}

	timeLim <- c(-28, 53)
	cmPlotsTimeSpec <- subjectProfileIntervalPlot(
		data = SDTMDataPelican$CM,
		paramVar = c("CMINDC", "CMDECOD", "CMDOSTXT", "CMDOSU", "CMROUTE", "CMDOSFRQ"),
		timeStartVar = "CMSTDY",
		timeEndVar = "CMENDY",
		paramGroupVar = "CMINDC",
		colorVar = "CMINDC",
		labelVars = labelVarsSDTMPelican,
		title = "Concomitant medications",
		timeLim = timeLim
	)

```

```{r exampleIntervalModule-cm-restrictedTimeLimits2-include, echo = FALSE, fig.height = getNLinesYGgplot(cmPlotsTimeSpec[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Concomitant medications with the 'subjectProfileIntervalPlot' function for patient:", names(cmPlotsTimeSpec)[1], "with time limits restricted to: (", toString(timeLim), ")")}

	print(cmPlotsTimeSpec[[1]][[1]])

```

## Event module

### General

The 'event' module enables to represent event data.

This is used to represent the presence/absence of a certain
laboratory measurement (and corresponding time).

```{r exampleEventModule}
	
	## laboratory data
	
	# prepare data for plots:
	dataLB <- SDTMDataPelican$LB
	# sort the categories (empty values '' becomes NA)
	dataLB$LBNRIND <- factor(dataLB$LBNRIND, levels = c("LOW", "NORMAL", "HIGH"))
	
	# create plot
	lbPlots <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		paramGroupVar = "LBSCAT",
		timeVar = "LBDY",
		labelVars = labelVarsSDTMPelican,
		title = "Laboratory test measurements"
	)

```

```{r exampleEventModule-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileEventPlot' function for patient:", names(lbPlots)[1])}

	print(lbPlots[[1]][[1]])

```

### Color variable

The reference range indicator is used to color the presence/absence of the
laboratory data via the `colorVar` parameter.
This parameter is also used for the symbol via the `shapeVar` variable.
Symbols specific of this categorization are used via the `shapePalette`
parameter: bottom/top arrow for low/high measurements, and dot for measurements
in normal range.

```{r exampleEventModuleWithColor}

	# create plot
	lbPlotsColor <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		paramGroupVar = "LBSCAT",
		timeVar = "LBDY",
		colorVar = "LBNRIND",
		labelVars = labelVarsSDTMPelican,
		shapeVar = "LBNRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24, 'NA' = 3),
		title = "Laboratory test measurements: reference range indicator"
	)
	
```

```{r exampleEventModuleWithColor-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlotsColor[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with reference range with the 'subjectProfileEventPlot' function for patient:", names(lbPlotsColor)[1])}

	print(lbPlotsColor[[1]][[1]])

```

### Subset of interest

If only a subset of parameters are of interest, the `subsetVar` and
`subsetValue` can be used. 
These parameters are also available for all other module types.
These parameters are here used to represent only the measurements for the
hematology parameters.

```{r exampleEventModuleWithSubset}

	# create plot
	lbPlotsSubset <- subjectProfileEventPlot(
		data = dataLB,
		paramVar = "LBTEST",
		subsetVar = "LBCAT", subsetValue = "HEMATOLOGY",
		timeVar = "LBDY",
		colorVar = "LBNRIND",
		labelVars = labelVarsSDTMPelican,
		shapeVar = "LBNRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24, 'NA' = 3),
		title = "Hematology test measurements: reference range indicator"
	)
	
```

```{r exampleEventModuleWithSubset-include, echo = FALSE, fig.height = getNLinesYGgplot(lbPlotsSubset[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Hematology data with the 'subjectProfileEventPlot' function for patient:", names(lbPlotsSubset)[1])}

	print(lbPlotsSubset[[1]][[1]])

```

## Line module

### General

The 'line' module enables to represent value of a variable across time.

This is used to represent the evolution of the lab parameters.

The reference range (`paramValueRangeVar` variable) of each variable is
highlighted in the plot.

```{r exampleLineModule}

	# create plot
	lbLinePlots <- subjectProfileLinePlot(
		data = dataLB,
		paramNameVar = "LBTEST", 
		paramValueVar = "LBSTRESN",
		paramGroupVar = "LBSCAT",
		paramValueRangeVar = c("LBSTNRLO", "LBSTNRHI"),
		timeVar = "LBDY",
		title = "Laboratory test measurements: actual value",
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleLineModule-include, echo = FALSE, fig.height = getNLinesYGgplot(lbLinePlots[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with the 'subjectProfileLinePlot' function for patient:", names(lbLinePlots)[1])}

	print(lbLinePlots[[1]][[1]])

```

### Color/symbols

The color and the shape of the points can be specified via the 
`colorVar` and `shapeVar` parameters, similarly as for
the `subjectProfileEventPlot` function.
The reference range measurement is represented via these parameters.

```{r exampleLineModule-colorShape}

	# create plot
	lbLinePlotsColorShape <- subjectProfileLinePlot(
		data = dataLB,
		paramNameVar = "LBTEST", 
		paramValueVar = "LBSTRESN",
		colorVar = "LBNRIND",
		shapeVar = "LBNRIND",
		shapePalette = c('LOW' = 25, 'NORMAL' = 19, 'HIGH' = 24),
		paramGroupVar = "LBSCAT",
		paramValueRangeVar = c("LBSTNRLO", "LBSTNRHI"),
		timeVar = "LBDY",
		title = "Laboratory test measurements: actual value",
		labelVars = labelVarsSDTMPelican
	)
	
```

```{r exampleLineModule-colorShape-include, echo = FALSE, fig.height = getNLinesYGgplot(lbLinePlotsColorShape[[1]][[1]])*heightLineIn, fig.width = 14, fig.cap = paste("Laboratory data with reference range with the 'subjectProfileLinePlot' function for patient:", names(lbLinePlotsColorShape)[1])}

	print(lbLinePlotsColorShape[[1]][[1]])

```

# Creation of subject report

The function `createSubjectProfileReport` has mainly two purposes:

* combining the plots of each patient across modules (via the
  `subjectProfileCombine` function)
* creating a _pdf_ report containing the resulting plots (one page per subject)

## Reference lines for Statistical Analysis Plan

```{r createReportWithAllModules-referenceLinesFromSAP, eval = FALSE}

	# reference lines input parameter
	library(glpgStyle)
	refLinesParam <- list(
		list(
			label = 'Start screening',
			time = -28,
			color = glpgPaletteCharts()["purple"]
		), 
		list(
			label = 'End screening',
			time = -1,
			color = glpgPaletteCharts()["purple"]
		), 
		list(
			label = 'Start treatment',
			time = 1,
			color = glpgPaletteCharts()["darkblue"]
		), 
		list(
			label = 'End treatment',
			time = 29,
			color = glpgPaletteCharts()["darkblue"]
		),
		list(
			label = 'Follow-up',
			time = 49,
			color = glpgPaletteCharts()["pink"]
		)
	)

	# create report
	system.time(createSubjectProfileReport(
		listPlots = list(
			dmPlots, 
			mhPlots, 
			cmPlotsTimeSV, 
			exPlots, 
			aePlots, 
			lbLinePlots, 
			lbPlotsColor
		),
		refLines = refLinesParam,
		timeLim = c(-20, 52),
		outputFile = "subjectProfile_SDTM_referenceLinesFromSAP.pdf",
		exportFigures = TRUE,
		verbose = TRUE
	)) # 14 mins

```

## Reference lines from subject visits

In the following example: the reference lines are extracted from the subject
visits: `SV` dataset. Bookmarks are used to reference the sex and arm for each
subject.

```{r createReportWithAllModules-referenceLinesFromSV, eval = FALSE}

	# create report
	createSubjectProfileReport(
		# general
		listPlots = list(dmPlots, mhPlots, exPlots, aePlots, lbPlotsColor),
		outputFile = "subjectProfile_SDTM_referenceLinesFromSV.pdf",
		# reference line(s)
		refLinesData = SDTMDataPelican$SV,
		refLinesTimeVar = "SVSTDY",
		refLinesLabelVar = "VISIT",
		# bookmark(s)
		bookmarkData = SDTMDataPelican$DM,
		bookmarkVar = c("SEX", "ARM"),
		labelVars = attr(SDTMDataPelican, "labelVars"),
		exportFigures = TRUE
	)

```

## Example with the 'ADaM' dataset/format

ADaM dataset can also be used in the same framework.

```{r createReportFromADAMDataset, eval = FALSE}

	# load example ADaM dataset
	data(ADaMDataPelican)
	# ... and corresponding labels
	data(labelVarsADaMPelican)

	# subject information
	slPlotsADaM <- subjectProfileTextPlot(
		ADaMDataPelican$ADSL,
		paramValueVar = c("SEX|AGE", "RACE|COUNTRY", "ARM"),
		labelVars = labelVarsADaMPelican
	)
	# medical history
	mhPlotsADaM <- subjectProfileTextPlot(
		ADaMDataPelican$ADMH,
		paramNameVar = "MHDECOD",
		paramValueVar = "MHENRTPT",
		title = "Medical History: status",
		labelVars = labelVarsADaMPelican
	)
	# exposure
	exPlotsADaM <- subjectProfileIntervalPlot(
		data = ADaMDataPelican$ADEX,
		paramVar = c("EXTRT", "EXDOSE", "EXDOSU"),
		timeStartVar = "EXSTDY",
		timeEndVar = "EXENDY",
		colorVar = "EXDOSFRM",
		labelVars = labelVarsADaMPelican,
		title = "Treatment exposure"
	)
	# adverse events
	aePlotsADaM <- subjectProfileIntervalPlot(
		data = ADaMDataPelican$ADAE,
		paramVar = "AETERM",
		timeStartVar = "ASTDY",
		timeEndVar = "AENDY",
		colorVar = "AESEV",
		labelVars = labelVarsADaMPelican,
		title = "Adverse events"
	)
	# laboratory	
	lbPlotsADaM <- subjectProfileEventPlot(
		data = ADaMDataPelican$ADLB,
		paramVar = "PARAM",
		paramGroupVar = c("PARCAT1", "PARCAT2"),
		timeVar = "ADY",
		colorVar = "ANRIND",
		labelVars = labelVarsADaMPelican,
		shapeVar = "ANRIND",
		title = "Laboratory test measurements",
		shapePalette = c('L' = 25, 'N' = 19, 'H' = 24, 'NA' = 3)
	)

	# create report
	createSubjectProfileReport(
		listPlots = list(slPlotsADaM, mhPlotsADaM, 
			exPlotsADaM, aePlotsADaM, lbPlotsADaM
		),
		refLines = refLinesParam,
		outputFile = "subjectProfile_ADAM.pdf"
	)

```

# Appendix

## Session information


```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
